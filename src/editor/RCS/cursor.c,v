head	1.3;
access;
symbols;
locks; strict;
comment	@ * @;


1.3
date	2002.01.18.08.38.43;	author tjaden;	state Exp;
branches;
next	1.2;

1.2
date	2002.01.18.07.47.12;	author tjaden;	state Exp;
branches;
next	1.1;

1.1
date	2002.01.12.20.15.08;	author tjaden;	state Exp;
branches;
next	;


desc
@@


1.3
log
@Fixed a problem where the dynamically created mouse cursor was
destroyed while in use by Allegro.
@
text
@/* cursor.c
 *
 * Peter Wang <tjaden@@users.sourceforge.net>
 */


#include <allegro.h>
#include "cursor.h"
#include "magic4x4.h"


#define HIGHLIGHT	(makecol (0xf0, 0xa0, 0xa0))


static BITMAP *dynamic_cursor;
static BITMAP *dot_cursor;


static void destroy_dynamic_cursor ()
{
    if (dynamic_cursor) {
	destroy_bitmap (dynamic_cursor);
	dynamic_cursor = 0;
    }
}


int cursor_init ()
{
    dot_cursor = create_bitmap (1, 1);
    putpixel (dot_cursor, 0, 0, HIGHLIGHT);
    cursor_set_default ();
    return 0;
}


void cursor_shutdown ()
{
    destroy_dynamic_cursor ();
    destroy_bitmap (dot_cursor);
}


static void change (BITMAP *bmp, int x, int y)
{
    scare_mouse ();
    set_mouse_sprite (bmp);
    set_mouse_sprite_focus (x, y);
    unscare_mouse ();
}


void cursor_set_magic_bitmap (BITMAP *bmp, int hotx, int hoty)
{
    BITMAP *tmp;
    int x, y;

    tmp = unget_magic_bitmap_format (bmp);
    if (!tmp) return;
    
    for (y = 0; y < tmp->h; y++)
	for (x = 0; x < tmp->w; x++)
	    if (getpixel (tmp, x, y) == makecol (0, 0, 0))
		putpixel (tmp, x, y, bitmap_mask_color (screen));

    hotx /= 3;
    putpixel (tmp, hotx, hoty, HIGHLIGHT);

    change (tmp, hotx, hoty);

    destroy_dynamic_cursor ();
    dynamic_cursor = tmp;
}


void cursor_set_dot ()
{
    change (dot_cursor, 0, 0);
    destroy_dynamic_cursor ();
}


void cursor_set_default ()
{
    change (0, 0, 0);
    destroy_dynamic_cursor ();
}
@


1.2
log
@Created dot cursor bitmap at module initialisation instead of creating
it everytime it was set to improve efficiency.
@
text
@d78 1
a79 1
    change (dot_cursor, 0, 0);
d85 1
a86 1
    change (0, 0, 0);
@


1.1
log
@Initial revision
@
text
@d15 2
a16 1
static BITMAP *cursor;
d19 1
a19 1
static void destroy_cursor ()
d21 3
a23 3
    if (cursor) {
	destroy_bitmap (cursor);
	cursor = 0;
d30 2
d39 2
a40 1
    destroy_cursor ();
d71 2
a72 2
    destroy_cursor ();
    cursor = tmp;
d78 2
a79 8
    BITMAP *tmp = create_bitmap (1, 1);
    if (!tmp) return;

    putpixel (tmp, 0, 0, HIGHLIGHT);
    change (tmp, 0, 0);

    destroy_cursor ();
    cursor = tmp;
d85 2
a86 4
    if (cursor) {
	change (0, 0, 0);
	destroy_cursor ();
    }
@
