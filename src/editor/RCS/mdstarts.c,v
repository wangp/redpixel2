head	1.4;
access;
symbols;
locks; strict;
comment	@ * @;


1.4
date	2002.07.03.07.48.42;	author tjaden;	state Exp;
branches;
next	1.3;

1.3
date	2002.02.07.07.25.52;	author tjaden;	state Exp;
branches;
next	1.2;

1.2
date	2002.01.24.07.15.16;	author tjaden;	state Exp;
branches;
next	1.1;

1.1
date	2002.01.12.20.15.08;	author tjaden;	state Exp;
branches;
next	;


desc
@@


1.4
log
@Updated for new Store
@
text
@/* mdstarts.c
 *
 * Peter Wang <tjaden@@users.sourceforge.net>
 */


#include <allegro.h>
#include "depths.h"
#include "editor.h"
#include "editarea.h"
#include "edselect.h"
#include "list.h"
#include "magic4x4.h"
#include "map.h"
#include "modes.h"
#include "modemgr.h"
#include "path.h"
#include "selbar.h"
#include "store.h"
#include "rect.h"


static BITMAP *icon;

static ed_select_list_t *list;
static int top, selected;


/* Save / restore selectbar state.  */
 
static void save_list (void)
{
    top = selectbar_top ();
    selected = selectbar_selected ();
}

static void restore_list (void)
{
    selectbar_set_top (top);
    selectbar_set_selected (selected);
}


/* Mode manager callbacks.  */

static void enter_mode (void)
{
    editarea_layer_activate ("starts");
    selectbar_set_list (list);
    selectbar_set_icon_size (32, 32);
    restore_list ();
} 

static void leave_mode (void)
{
    save_list ();
    selectbar_set_list (0);
}

static struct editmode start_mode = {
    "starts",
    enter_mode,
    leave_mode
};


/* Editarea callbacks.  */

static void draw_layer (BITMAP *bmp, int offx, int offy)
{
    list_head_t *list;
    start_t *p;

    offx *= 16;
    offy *= 16;

    list = map_start_list (editor_map);
    list_for_each (p, list)
	draw_trans_magic_sprite (bmp, icon, 
				 (map_start_x (p) - offx) - (icon->w / 3 / 2),
				 (map_start_y (p) - offy) - (icon->h / 2));
}

static start_t *find_start (int x, int y)
{
    list_head_t *list;
    start_t *p, *last = NULL;

    list = map_start_list (editor_map);
    list_for_each (p, list)
	if (in_rect (x, y, map_start_x (p) - icon->w/3/2, 
		     map_start_y (p) - icon->h/2,
		     icon->w/3, icon->h))
	    last = p;

    return last;
}

static int event_layer (int event, struct editarea_event *d)
{
    static start_t *old;    
    start_t *p;
    int x, y;

    #define map_x(x)	((d->offx * 16) + (x))
    #define map_y(y)	((d->offy * 16) + (y))

    switch (event) {
	    
	case EDITAREA_EVENT_MOUSE_DOWN:
	    x = map_x (d->mouse.x);
	    y = map_y (d->mouse.y);
	    p = find_start (x, y);
	    
	    if (d->mouse.b == 0) {
		if (p)
		    old = p;
		else {
		    old = map_start_create (editor_map, x, y);
		    return 1;
		}
	    }
	    else if ((d->mouse.b == 1) && (p)) {
		map_start_destroy (p);
		return 1;
	    }
	    break;
	    
	case EDITAREA_EVENT_MOUSE_MOVE:
	    if (old) {
		map_start_move (old, map_x (d->mouse.x), map_y (d->mouse.y));
		return 1;
	    }
	    break;

	case EDITAREA_EVENT_MOUSE_UP:
	    old = NULL;
	    break;
    }
    
    return 0;
}


/* Module init / shutdown.  */

int mode_starts_init (void)
{
    modemgr_register (&start_mode);
    editarea_layer_register ("starts", draw_layer, event_layer, DEPTH_STARTS);

    if (!(icon = store_get_dat ("/editor/start/000")))
	return -1;

    list = ed_select_list_create ();
    ed_select_list_add_item (list, "start", icon);

    return 0;
}

void mode_starts_shutdown (void)
{
    ed_select_list_destroy (list);
}
@


1.3
log
@Don't destroy bitmaps inside store.
@
text
@d152 1
a152 1
    if (!(icon = store_dat ("/editor/start/000")))
@


1.2
log
@Changed all "()" declarations to "(void)".
@
text
@a163 1
    destroy_bitmap (icon);
@


1.1
log
@Initial revision
@
text
@d31 1
a31 1
static void save_list ()
d37 1
a37 1
static void restore_list ()
d46 1
a46 1
static void enter_mode ()
d54 1
a54 1
static void leave_mode ()
d147 1
a147 1
int mode_starts_init ()
d161 1
a161 1
void mode_starts_shutdown ()
@
