head	1.5;
access;
symbols;
locks; strict;
comment	@ * @;


1.5
date	2002.07.03.07.49.14;	author tjaden;	state Exp;
branches;
next	1.4;

1.4
date	2002.02.11.04.28.42;	author tjaden;	state Exp;
branches;
next	1.3;

1.3
date	2002.01.24.07.15.16;	author tjaden;	state Exp;
branches;
next	1.2;

1.2
date	2002.01.22.04.02.21;	author tjaden;	state Exp;
branches;
next	1.1;

1.1
date	2002.01.12.20.15.08;	author tjaden;	state Exp;
branches;
next	;


desc
@@


1.5
log
@Updated for new Store
@
text
@/* editor.c
 *
 * Peter Wang <tjaden@@users.sourceforge.net>
 */


#include <allegro.h>
#include "gui.h"
#include "ug.h"
#include "cursor.h"
#include "extdata.h"
#include "store.h"
#include "path.h"

#include "editarea.h"
#include "menu.h"
#include "modebar.h"
#include "selbar.h"

#include "modemgr.h"
#include "modes.h"

#include "map.h"


static store_file_t support_file;
map_t *editor_map;


int editor_init (void)
{
    support_file = store_load_ex ("data/editor/editor-support.dat", "/editor/",
				  load_extended_datafile);
    return (support_file) ? 0 : -1;
}


void editor_shutdown (void)
{
    store_unload (support_file);
}


int editor_run (void)
{
    FONT *old_font = font;

    font = store_get_dat ("/editor/font");

    if ((gui_init () < 0)
	|| (ug_init () < 0)
	|| (cursor_init () < 0))
	goto error;

	editarea_install  (0, 0, SCREEN_W - 32, SCREEN_H - 16);
	selectbar_install (SCREEN_W - 32, 0, 32, SCREEN_H);
	modebar_install   (70, SCREEN_H - 16, SCREEN_W - 70 - 32, 16);
	menu_install      (0, SCREEN_H - 16, 70, 16);

	    modemgr_init ();
	    if ((mode_tiles_init () < 0)
		|| (mode_lights_init () < 0)
		|| (mode_objects_init () < 0)
		|| (mode_starts_init () < 0))
		goto error;
	    modemgr_select ("tiles");

		editor_map = map_create (0);
		map_resize (editor_map, 64, 64);

		gui_main ();

		map_destroy (editor_map);
	    
	    mode_starts_shutdown ();
	    mode_objects_shutdown ();
	    mode_lights_shutdown ();
	    mode_tiles_shutdown ();
	    modemgr_shutdown ();

	menu_uninstall ();
	modebar_uninstall ();
	selectbar_uninstall ();
	editarea_uninstall ();
    
    cursor_shutdown ();
    ug_shutdown ();
    gui_shutdown ();

    font = old_font;
    return 0;

  error:

    font = old_font;
    return 1;
}
@


1.4
log
@Made editor more friendly to being run more than once in a process.
@
text
@d26 1
a26 1
static int store_id;
d32 3
a34 3
    store_id = store_load_ex ("data/editor/editor-support.dat", "/editor/",
			      load_extended_datafile);
    return (store_id < 0) ? -1 : 0;
d40 1
a40 1
    store_unload (store_id);
d48 1
a48 1
    font = store_dat ("/editor/font");
@


1.3
log
@Changed all "()" declarations to "(void)".
@
text
@d11 1
a11 1
#include "mylua.h"
d26 1
d30 1
a30 1
int editor (void)
d32 4
a35 1
    FONT *f;
a36 1
    lua_dofile_path (lua_state, "editor/editor-init.lua");
d38 11
a48 2
    if ((f = store_dat ("/editor/font")))
	font = f;
d53 1
a53 1
	return 1;
d65 1
a65 1
		return 1;
d90 1
d92 5
@


1.2
log
@Only run editor-init.lua when actually running the editor.
This allows us to put in editor-specific code in there.
@
text
@d29 1
a29 1
int editor ()
@


1.1
log
@Initial revision
@
text
@d11 1
d32 2
@
